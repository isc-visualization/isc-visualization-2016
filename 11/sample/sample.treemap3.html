<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="utf-8">
    <title>D3 페이지 템플릿</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>

    </style>
</head>

<body>
</svg>
    <script type="text/javascript">
    var parse = d3.timeParse('%Y-%m-%d');
    d3.json('flare.json', callback)
    function callback(err, data) {
      if(err) return console.error(err);
      var hierarchy = d3.hierarchy(data, function(d){return d.children});
      hierarchy.sum(function(d){return d.size})
        .sort(function(a, b) { return b.height - a.height || b.value - a.value; });

      var w = 600, h = 300;
      var margin = {top:10, right:10, bottom: 10, left: 10};
      var innerW = w - margin.right - margin.left,
        innerH = h - margin.top - margin.bottom;

      var svg = d3.select('body').append('svg')
          .attr('width', w)
          .attr('height', h)
        .append('g')
          .attr('transform', 'translate('+ [margin.left, margin.top] + ')');

      var opacityDomain = d3.extent(hierarchy.leaves(), function(d){return d.value;});
      var opacity = d3.scaleLinear().domain(opacityDomain).range([0.4, 1.0]);
      var colorDomain = hierarchy.children.map(function(d){return d.data.name});
      var color = d3.scaleOrdinal().domain(colorDomain).range(d3.schemeCategory10);
      var paddingTop = 16;
      var treemap = d3.treemap()
        .size([innerW, innerH])
        .paddingTop(paddingTop);

      hierarchy = treemap(hierarchy);

      svg.call(node, [hierarchy]);
      function node(_selection, d) {
        var el = _selection.selectAll('.node')
          .data(d, function(d){return d.data.key;});
        el.enter().append('g')
          .attr('class', 'node')
          .each(function(d) {
            if(d.children) {
              d3.select(this).call(parent)
                .call(node, d.children);
            } else {
              d3.select(this).call(leaf);
            }
          })
        return _selection;
      }
      function parent(_selection) {
        _selection.classed('parent', true);
        _selection.append('rect')
          .attr('width', function(d){return d.x1-d.x0;})
          .attr('height', function(d){return paddingTop;})
          .attr('x', function(d){return d.x0;})
          .attr('y', function(d){return d.y0;})
          .style('fill', '#eee')
          .style('stroke', '#ddd')
          .style('cursor', 'pointer');
        _selection.append('text')
          .text(function(d){return d.data.name})
          .attr('dy', function(d){return '1em'})
          .attr('x', function(d){return d.x0;})
          .attr('y', function(d){return d.y0;})
          .style('font-size', '12px')
          .style('font-family', 'sans-serif')
          .style('pointer-events', 'none');
        _selection.select('rect').on('mouseenter', function(d) {
          d3.event.stopPropagation();
          d3.select(d3.select(this).node().parentNode).selectAll('.leaf > rect')
            .style('fill', 'lemonchiffon')
        }).on('mouseleave', function(d) {
          d3.event.stopPropagation();
          d3.select(d3.select(this).node().parentNode).selectAll('.leaf > rect')
            .style('fill', function(d){return color(findParent(d, 1).data.name)})
        })
        return _selection;
      }
      function leaf(_selection) {
        _selection.classed('leaf', true)
          .append('rect')
          .attr('x', function(d){return d.x0})
          .attr('y', function(d){return d.y0})
          .attr('width', function(d){return d.x1-d.x0})
          .attr('height', function(d){return d.y1-d.y0})
          .style('fill', function(d){return color(findParent(d, 1).data.name)})
          .style('fill-opacity', function(d){return opacity(d.value)});
        return _selection;
      }
      function findParent(node, depth) {

        if(node.depth < depth) {
          return null;
        } else if(node.depth === depth) {
          return node;
        }
        if(node.parent) {
          return findParent(node.parent, depth); //재귀 recursion
        }
      }
    } // end of callaback



    </script>
</body>

</html>
